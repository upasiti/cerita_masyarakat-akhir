const CACHE_VERSION="v3.0.6",CACHE_NAME="cerita-cache-v3.0.6";self.skipWaiting();const ASSETS_TO_CACHE=["./","./index.html","./offline.html","./app.bundle.js","./app.css","./manifest.json","./images/icon-192.png","./images/icon-512.png","./images/logo.png"];let userToken=null;async function syncPendingStories(){try{const e=await openSyncDB(),t=e.transaction("pending-stories","readonly").objectStore("pending-stories"),n=await new Promise((e=>{const n=t.getAll();n.onsuccess=()=>e(n.result)}));if(!n||0===n.length)return void console.log("ðŸ“­ Tidak ada cerita pending untuk disinkronkan.");for(const t of n)try{const n=new FormData;n.append("description",t.description),t.lat&&t.lon&&(n.append("lat",t.lat),n.append("lon",t.lon));const o=await fetch(t.photoUrl).then((e=>e.blob()));n.append("photo",o,"photo.jpg");const a=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${userToken}`},body:n});if(!a.ok)throw new Error(`Upload gagal (${a.status})`);e.transaction("pending-stories","readwrite").objectStore("pending-stories").delete(t.createdAt),console.log("âœ… Cerita tersinkron:",t.description),self.registration.showNotification("Cerita berhasil disinkronkan!",{body:t.description.length>60?t.description.substring(0,60)+"...":t.description,icon:"/images/icon-192.png",badge:"/images/icon-192.png",data:{url:"/"}})}catch(e){console.error("âŒ Gagal upload cerita:",e.message)}}catch(e){console.error("âŒ Gagal membuka IndexedDB:",e)}}function openSyncDB(){return new Promise(((e,t)=>{const n=indexedDB.open("story-sync-db",1);n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("pending-stories")||t.createObjectStore("pending-stories",{keyPath:"createdAt"})},n.onsuccess=t=>e(t.target.result),n.onerror=e=>t(e.target.error)}))}self.addEventListener("message",(e=>{"SET_TOKEN"===e.data?.type&&(userToken=e.data.token,console.log("ðŸ”‘ Token disimpan di Service Worker:",userToken))})),self.addEventListener("install",(e=>{console.log("âœ… Service Worker: Installed"),e.waitUntil(caches.open(CACHE_NAME).then((e=>e.addAll(ASSETS_TO_CACHE))))})),self.addEventListener("activate",(e=>{console.log("âš¡ Service Worker: Activated"),e.waitUntil(caches.keys().then((e=>Promise.all(e.filter((e=>e!==CACHE_NAME)).map((e=>caches.delete(e)))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(e=>{if("GET"!==e.request.method)return;const t=e.request,n=new URL(t.url).origin.includes("story-api.dicoding.dev");e.respondWith((async()=>{const e=await caches.open(CACHE_NAME);try{const n=await fetch(t),o=n.clone();return e.put(t,o),n}catch(o){const a=await e.match(t);return a||(n?(console.warn("âš ï¸ Offline mode, data API tidak tersedia"),new Response(JSON.stringify({error:!0,message:"Offline â€“ data tidak tersedia"}),{headers:{"Content-Type":"application/json"}})):await e.match("./offline.html")||new Response("Anda sedang offline.",{status:503}))}})())})),self.addEventListener("push",(e=>{let t={};try{t=e.data?e.data.json():{}}catch{t={title:"Notifikasi",body:e.data.text()}}const n=t.title||"Notifikasi Baru!",o={body:t.body||"Ada pembaruan dari Cerita Masyarakat.",icon:"/images/icon-192.png",badge:"/images/icon-192.png",data:{url:t.url||"/"},actions:[{action:"open_url",title:"Lihat Detail"}]};e.waitUntil(self.registration.showNotification(n,o))})),self.addEventListener("notificationclick",(e=>{e.notification.close();const t=e.notification?.data?.url||"/";"open_url"!==e.action&&""!==e.action||e.waitUntil(clients.openWindow(t))})),self.addEventListener("sync",(e=>{"sync-stories"===e.tag&&(console.log("ðŸ“¶ Menjalankan background sync..."),e.waitUntil(syncPendingStories()))}));