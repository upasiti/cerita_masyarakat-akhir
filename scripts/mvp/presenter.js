import StoryModel from"./model.js";import StoryView from"./view.js";class StoryPresenter{constructor(t,a){this.model=t,this.view=a,this.map=null,this.markers=[]}async init(){if(!localStorage.getItem("token"))return alert("Sesi login telah berakhir. Silakan login kembali."),void(window.location.hash="#/login");const t=await this.showStories();this.initMap(),this.updateMapMarkers(t)}async showStories(){try{this.view.showLoading();const t=await this.model.getStories();return this.view.displayStories(t),this.stories=t,this.view.bindDetailButton(t,((t,a)=>{this.map&&t&&a?(this.map.setView([t,a],15),L.marker([t,a]).addTo(this.map).bindPopup("Lokasi Cerita").openPopup(),setTimeout((()=>this.map.flyTo([t,a],15,{duration:1.5})),100)):console.warn("❌ Peta belum siap atau koordinat tidak valid")})),this.view.bindSaveFavorite(t,(async t=>{try{await this.model.saveFavorite(t),alert(`Story "${t.name}" telah disimpan ke favorit!`)}catch(t){console.error("Gagal menyimpan story:",t),alert("❌ Terjadi kesalahan saat menyimpan story.")}})),t}catch(t){return console.error(t),this.view.showError(t.message),[]}finally{this.view.hideLoading()}}initMap(){if(!document.getElementById("map"))return;this.map=L.map("map").setView([-2.5489,118.0149],5);const t=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}),a=L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{attribution:"© Google Satellite",subdomains:["mt0","mt1","mt2","mt3"]});t.addTo(this.map),L.control.layers({"Street Map":t,Satellite:a}).addTo(this.map)}updateMapMarkers(t){this.map&&(this.markers.forEach((t=>this.map.removeLayer(t))),this.markers=[],t.forEach((t=>{if(t.lat&&t.lon){const a=L.marker([t.lat,t.lon]).addTo(this.map).bindPopup(`\n            <div class="popup-content">\n              <img src="${t.photoUrl}" alt="${t.description}" \n                   style="width: 100px; height: 100px; object-fit: cover;">\n              <h4>${t.name}</h4>\n              <p>${t.description}</p>\n            </div>\n          `);this.markers.push(a)}})))}async addStory(t){try{const a=await this.model.addStory(t);if(!1===a.error){const t=await this.showStories();return this.updateMapMarkers(t),{success:!0,message:a.message}}throw new Error(a.message||"Gagal menambahkan cerita")}catch(t){return console.error("Gagal menambahkan cerita:",t),{success:!1,message:t.message}}}async handleAddStory(t){try{this.view.showLoading();const a=await this.model.addStory(t);if(!1===a.error){this.view.showMessage("Cerita berhasil ditambahkan!");const t=await this.showStories();this.updateMapMarkers(t)}else this.view.showError(a.message)}catch(t){this.view.showError("Gagal menambahkan cerita!")}finally{this.view.hideLoading()}}}export default StoryPresenter;