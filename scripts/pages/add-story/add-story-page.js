import StoryModel from"../../mvp/model.js";import StoryView from"../../mvp/view.js";import StoryPresenter from"../../mvp/presenter.js";import Camera from"../../utils/camera.js";import{checkAuth}from"../../utils/auth.js";import{savePendingStory}from"../../data/sync-db.js";export default class AddStoryPage{constructor(){this.model=new StoryModel,this.view=new StoryView,this.presenter=new StoryPresenter(this.model,this.view),this.camera=new Camera,this.selectedLocation=null,this.map=null}async render(){return'\n      <section class="container">\n        <a href="#main-content" class="skip-link">Skip to content</a>\n        <h1 tabindex="0">Tambah Cerita Baru</h1>\n        \n        <form id="add-story-form" class="story-form">\n          <div class="form-group">\n            <label for="description">Deskripsi Cerita:</label>\n            <textarea id="description" name="description" required aria-required="true" rows="4"></textarea>\n            <span class="error-message" id="description-error"></span>\n          </div>\n\n          <div class="form-group">\n            <label for="photo">Foto:</label>\n            <input type="file" id="photo" name="photo" accept="image/*" required aria-required="true">\n            <span class="error-message" id="photo-error"></span>\n            \n            <div class="camera-options">\n              <button type="button" id="camera-btn" class="camera-btn">Ambil Foto dari Kamera</button>\n              <video id="camera-preview" style="display:none" aria-label="Preview kamera"></video>\n              <canvas id="camera-capture" style="display:none"></canvas>\n              <button type="button" id="capture-btn" style="display:none" class="capture-btn">Ambil Foto</button>\n            </div>\n\n            <div id="image-preview" class="image-preview"></div>\n          </div>\n\n          <div class="form-group">\n            <label>Pilih Lokasi di Peta:</label>\n            <div id="location-map" class="location-map"></div>\n            <p id="selected-location" class="location-info">Belum memilih lokasi</p>\n          </div>\n\n          <button type="submit" class="submit-btn">Tambah Cerita</button>\n          <div id="form-message" class="form-message"></div>\n        </form>\n      </section>\n    '}async afterRender(){checkAuth()&&(await this.loadLeaflet(),this.initMap(),this.setupFormValidation(),this.setupCamera())}loadLeaflet(){return new Promise((e=>{if(window.L)return e();const t=document.createElement("link");t.rel="stylesheet",t.href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css",document.head.appendChild(t);const a=document.createElement("script");a.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js",a.onload=e,document.head.appendChild(a)}))}initMap(){this.map=L.map("location-map").setView([-2.5489,118.0149],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(this.map),this.map.on("click",(e=>{this.selectedLocation=e.latlng,this.locationMarker&&this.map.removeLayer(this.locationMarker),this.locationMarker=L.marker(e.latlng).addTo(this.map).bindPopup("Lokasi terpilih").openPopup(),document.getElementById("selected-location").textContent=`Lokasi terpilih: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`,document.getElementById("selected-location").style.color=""}))}setupFormValidation(){const e=document.getElementById("add-story-form"),t=document.getElementById("description"),a=document.getElementById("photo");t.addEventListener("input",(()=>{this.validateField(t,"description-error","Deskripsi harus diisi")})),a.addEventListener("change",(e=>{this.validatePhoto(e.target)})),e.addEventListener("submit",(async e=>{e.preventDefault(),await this.validateForm()&&await this.submitForm()}))}validateField(e,t,a){const n=document.getElementById(t);return e.value.trim()?(n.textContent="",e.setAttribute("aria-invalid","false"),!0):(n.textContent=a,e.setAttribute("aria-invalid","true"),!1)}validatePhoto(e){const t=document.getElementById("photo-error");if(e.files&&0!==e.files.length){t.textContent="",e.setAttribute("aria-invalid","false");const a=e.files[0],n=new FileReader;return n.onload=e=>{document.getElementById("image-preview").innerHTML=`\n          <img src="${e.target.result}" alt="Preview foto" class="preview-image">\n        `},n.readAsDataURL(a),!0}return t.textContent="Foto harus dipilih",e.setAttribute("aria-invalid","true"),!1}async validateForm(){const e=this.validateField(document.getElementById("description"),"description-error","Deskripsi harus diisi"),t=this.validatePhoto(document.getElementById("photo"));return this.selectedLocation?e&&t:(document.getElementById("selected-location").style.color="red",!1)}setupCamera(){const e=document.getElementById("camera-btn"),t=document.getElementById("camera-preview"),a=document.getElementById("capture-btn"),n=document.getElementById("photo"),i=document.createElement("button");i.textContent="Batalkan Kamera",i.type="button",i.className="cancel-btn",i.style.display="none",e.parentNode.insertBefore(i,t.nextSibling),e.addEventListener("click",(async()=>{try{await this.camera.startCamera(t),t.style.display="block",a.style.display="block",i.style.display="block",e.style.display="none"}catch(e){this.showMessage("Tidak dapat mengakses kamera: "+e.message,"error")}})),a.addEventListener("click",(async()=>{try{const o=await this.camera.capturePhoto(t);if(o instanceof File){const e=new DataTransfer;e.items.add(o),n.files=e.files,n.dispatchEvent(new Event("change"))}this.camera.stopCamera(),t.style.display="none",a.style.display="none",i.style.display="none",e.style.display="block"}catch(e){this.showMessage("Gagal mengambil foto: "+e.message,"error")}})),i.addEventListener("click",(()=>{this.camera.stopCamera(),t.style.display="none",a.style.display="none",i.style.display="none",e.style.display="block"}))}async submitForm(){const e=document.getElementById("add-story-form"),t=e.querySelector(".submit-btn"),a=document.getElementById("form-message"),n=localStorage.getItem("token");if(!n)return this.showMessage("Token tidak ditemukan. Silakan login ulang.","error"),void(window.location.hash="#/login");try{t.disabled=!0,t.textContent="Mengirim...",a.textContent="";const n=new FormData;n.append("description",document.getElementById("description").value),n.append("photo",document.getElementById("photo").files[0]),this.selectedLocation&&(n.append("lat",this.selectedLocation.lat),n.append("lon",this.selectedLocation.lng));const i=await this.presenter.addStory(n);if(!i.success)throw new Error(i.message);this.showMessage("Cerita berhasil ditambahkan!","success"),e.reset(),document.getElementById("image-preview").innerHTML="",setTimeout((()=>window.location.hash="#/"),2e3)}catch(e){console.warn("ðŸ“´ Offline: menyimpan cerita ke pending DB",e);const t=document.getElementById("photo").files[0],a=URL.createObjectURL(t),i={description:document.getElementById("description").value,photoUrl:a,lat:this.selectedLocation?.lat,lon:this.selectedLocation?.lng,createdAt:(new Date).toISOString()};if(await savePendingStory(i),this.showMessage("ðŸ“´ Offline: cerita disimpan dan akan dikirim saat online!","warning"),navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"SET_TOKEN",token:n}),"serviceWorker"in navigator&&"SyncManager"in window){const e=await navigator.serviceWorker.ready;await e.sync.register("sync-stories"),console.log("ðŸ“¡ Cerita offline akan disinkronkan nanti.")}}finally{t.disabled=!1,t.textContent="Tambah Cerita"}}showMessage(e,t){const a=document.getElementById("form-message");a.textContent=e,a.className=`form-message ${t}`}}